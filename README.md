# `grcov` Action

[![Sponsoring](https://img.shields.io/badge/Support%20it-Say%20%22Thank%20you!%22-blue)](https://actions-rs.github.io/#sponsoring)
![MIT licensed](https://img.shields.io/badge/license-MIT-blue.svg)
[![Gitter](https://badges.gitter.im/actions-rs/community.svg)](https://gitter.im/actions-rs/community)
![Continuous integration](https://github.com/actions-rs/grcov/workflows/Continuous%20integration/badge.svg)
![Dependabot enabled](https://api.dependabot.com/badges/status?host=github&repo=actions-rs/grcov)
![Experimental status](https://img.shields.io/badge/status-experimental-yellow.svg)

This GitHub Action collects and aggregates code coverage data with the
[grcov](https://github.com/mozilla/grcov) tool.

**NOTE: This branch (`0.2-proto`) is experimental. Use it at your own risk!

**Table of Contents**

* [Example workflow](#example-workflow)
* [Inputs](#inputs)
* [Outputs](#outputs)
* [Notes](#notes)
* [License](#license)
* [Contribute and support](#contribute-and-support)

## Example workflow

```yaml
on: [push]

name: Code Coverage

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
      - uses: actions-rs/cargo@v1
        with:
          command: test
          args: --all-features --no-fail-fast
        env:
          CARGO_INCREMENTAL: "0"
          RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort"
          RUSTDOCFLAGS: "-Cpanic=abort"

      # TODO: This step is temporary using `0.2-proto` version!
      # After the proper `v0.2` release, `0.2-proto` version will be removed
      # and it will break your CI; you should understand that before copying it.
      - uses: actions-rs/grcov@0.2-proto
        with:
          args: >
            -t lcov
            --llvm
            --branch
            --ignore-not-existing
            --ignore "/*"
            -o ./target/lcov.info
            ./target/debug/
```

## Usage

1. As `grcov` works with coverage data generated by the unstable [`-Z profile` feature](https://github.com/rust-lang/rust/issues/42524),
    you need to install `nightly` toolchain, for example,
    with the [`actions-rs/toolchain`](https://github.com/actions-rs/toolchain) Action:
    
    ```yaml
    - uses: actions-rs/toolchain@v1
      with:
        toolchain: nightly
        profile: minimal
        override: true
    ```

2. It is strongly recommended to call `cargo clean` command
    if any of `cargo check`, `cargo build`, `cargo test`
    or other similar commands were executed already in this workspace.

    ```yaml
    - run: cargo clean
    ```

3. Execute the `cargo test` command.
    It is required to add `CARGO_INCREMENTAL` and `RUSTFLAGS` environment variables
    for this command, see [grcov](https://github.com/mozilla/grcov) page for details.

    ```yaml
    - run: cargo test --all-features --no-fail-fast  # Customize args for your own needs
      env:
        CARGO_INCREMENTAL: "0"
        RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Copt-level=0 -Clink-dead-code -Coverflow-checks=off -Zpanic_abort_tests -Cpanic=abort"
        RUSTDOCFLAGS: "-Cpanic=abort"
    ```

4. Add the `actions-rs@grcov` Action to the workflow.

    ```yaml
      # TODO: This step is temporary using `0.2-proto` version!
      # After the proper `v0.2` release, `0.2-proto` version will be removed
      # and it will break your CI; you should understand that before copying it.
      - id: coverage
        uses: actions-rs/grcov@0.2-proto
        with:
          args: >
            -t lcov
            --llvm
            --branch
            --ignore-not-existing
            --ignore "/*"
            -o ./target/lcov.info
            ./target/debug/  # Note that you need to point grcov to the target directory with build artifacts
    ```
   
   Refer to [`grcov` documentation](https://github.com/mozilla/grcov#man-grcov)
   to see all available flags, options and arguments.
   Note that some arguments are populated by this Action for you,
   refer to [Inputs](#inputs) section for more details.

5. After the successful execution, `actions-rs/grcov` Action
    will set an [output](https://help.github.com/en/actions/building-actions/metadata-syntax-for-github-actions#outputs) called `output-path`
    with an absolute path to the coverage report file
    or directory (depending on the `--output-type` argument).

    This file can be uploaded to any code coverage service,
    ex. with [codecov](https://github.com/marketplace/actions/codecov) or [coveralls](https://github.com/marketplace/actions/coveralls-github-action) Actions help:

    ```yaml
    - name: Coveralls upload
      uses: coverallsapp/github-action@master
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        path-to-lcov: ${{ steps.coverage.outputs.report }}
    ```

## Inputs

| Name   | Required | Description                                                                      | Type   | Default |
| ------ | :------: | -------------------------------------------------------------------------------- | ------ | --------|
| `args` |          | [`grcov` flags, options and arguments](https://github.com/mozilla/grcov#man-grcov) | string |         |

The following options are automatically populated from the
[default environment variables](https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables#default-environment-variables)
and passed to `grcov`.\
If required, they can be overridden manually via the `args` input.

| Name                  | Default value                     |
| --------------------- | --------------------------------- |
| `-s`, `--source-dir`  | `$GITHUB_WORKSPACE`               |
| `--commit-sha`        | `$GITHUB_SHA`                     |
| `--service-name`      | `$GITHUB_WORKFLOW`                |
| `-service-job-id`     | `$GITHUB_RUN_ID`                  |
| `-o`, `--output-path` | Depends on `--output-type` option |

## Outputs

* `output-path`: Absolute path to the report file or directory

## Notes

1. [Coveralls](https://github.com/marketplace/actions/coveralls-github-action) Action is expecting `LCOV` format,
    do not use the `coveralls` or `coveralls+` output type for the `grcov`.\
    Instead, set the `output-type` config value to `lcov`.

2. Generated report file is stored in the temporary directory by default,
    which might not be accessible by the Docker-based Actions,
    such as [codecov](https://github.com/marketplace/actions/codecov).\
    Consider either mount it as [a Docker volume](https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idcontainervolumes)
    or use the `output-path` option in the [config](#config)
    to store report in the path accessible by container.

## License

This Action is distributed under the terms of the MIT license, see [LICENSE](https://github.com/actions-rs/toolchain/blob/master/LICENSE) for details.

## Contribute and support

Any contributions are welcomed!

If you want to report a bug or have a feature request,
check the [Contributing guide](https://github.com/actions-rs/.github/blob/master/CONTRIBUTING.md).

You can also support author by funding the ongoing project work,
see [Sponsoring](https://actions-rs.github.io/#sponsoring).
